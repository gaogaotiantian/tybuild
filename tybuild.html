<html>
<head>
  <meta charset="UTF-8">
  <script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.11.3.min.js"></script>
  <link rel="stylesheet" href="./tybuild_style.css"/>
  <script>
    $(document).ready(function() {
        var userBasic = {};
      function InitializeUser() {
        var user = {};
        user.minAttack = 0;
        user.minDamage = 0;
        user.maxDamage = 0;
        return user;
      }
      function GetDamage(user) {
        if (jQuery.isEmptyObject(user)) {
          return 0;
        }
        var damage = (user.minDamage + user.maxDamage + user.minSkillDamage + user.maxSkillDamage) / 2 * (1 + user.criticalRate * user.criticalDamage)
        return Math.round(damage);
      }
      function GetUser() {
        var user = {};
        user.minDamage = parseInt($("#user_min_damage").val());
        user.maxDamage = parseInt($("#user_max_damage").val());
        user.extraDamage = parseInt($("#user_extra_damage").val());
        user.shengeAttack = parseInt($('#user_shenge_attack').val());
        user.skillAttack = parseInt($('#user_skill_attack').val());
        user.criticalValue = parseInt($('#user_critical_value').val());
        user.extraCriticalRate = parseFloat($('#user_extra_critical_rate').val());
        user.criticalDamageValue = parseInt($('#user_critical_damage_value').val());
        user.extraCriticalDamageRate = parseFloat($('#user_extra_critical_damage_rate').val());
        user.minSkillDamage = parseInt($('#user_min_skill_damage').val());
        user.maxSkillDamage = parseInt($('#user_max_skill_damage').val());
        user.power = parseInt($("#user_power_potential").val()) + parseInt($("#user_power_other").val());


        user.lidao = parseInt(user.power / 10) * 4;
        user.criticalRate = (user.criticalValue / 3150 + user.extraCriticalRate/100);
        user.criticalDamage = Math.min(2, (0.5 + user.criticalDamageValue / 1050 + user.extraCriticalDamageRate/100));
        user.minAttack = (user.minDamage - user.extraDamage) / ((1 + user.lidao/100) * (1 + user.skillAttack/100));
        user.maxAttack = (user.maxDamage - user.extraDamage) / ((1 + user.lidao/100) * (1 + user.skillAttack/100));
        user.equipDamage = Math.round(user.extraDamage / 1.1128 / (1+user.shengeAttack/100) - user.power);
        user.minEquipAttack = Math.round(user.minAttack / 1.1128 / (1+user.shengeAttack/100));
        user.maxEquipAttack = Math.round(user.maxAttack / 1.1128 / (1+user.shengeAttack/100));
        user.damage = GetDamage(user);
        return user;
      }
      function UpdateUser(user) {
        user.criticalRate = (user.criticalValue / 3150 + user.extraCriticalRate/100);
        user.criticalDamage = Math.min(2, (0.5 + user.criticalDamageValue / 1050 + user.extraCriticalDamageRate/100));
        user.extraDamage = (user.equipDamage + user.power) * 1.1128 * (1+user.shengeAttack/100);
        user.lidao = parseInt(user.power / 10) * 4;
        user.minAttack = user.minEquipAttack * 1.1128 * (1+user.shengeAttack/100);
        user.maxAttack = user.maxEquipAttack * 1.1128 * (1+user.shengeAttack/100);
        user.minDamage = user.minAttack * (1 + user.lidao/100) * (1 + user.skillAttack/100) + user.extraDamage;
        user.maxDamage = user.maxAttack * (1 + user.lidao/100) * (1 + user.skillAttack/100) + user.extraDamage;
      }
      function EquipUser(user, equip) {
        var newUser = $.extend({}, user); 
        for (var key in newUser) {
          if (key in equip) {
            newUser[key] += equip[key];
          }
        }
        UpdateUser(newUser);
        return newUser;
      }
      function UpdateJuexing() {
        var juexingMap = {
          "power":[6, "#juexing_power"],
          "equipDamage":[27, "#juexing_equip_damage"],
          "maxEquipAttack" :[30, "#juexing_max_attack"], 
          "criticalValue"  :[54, "#juexing_critical_value"],
          "extraCriticalRate" : [2.5, "#juexing_extra_critical_rate"],
          "criticalDamageValue"  :[54, "#juexing_critical_damage_value"],
          "extraCriticalDamageRate" : [7.6, "#juexing_extra_critical_damage_rate"]
        }
        for (juexing in juexingMap) {
          var newUser = {}
          var equip = {};
          equip[juexing] = juexingMap[juexing][0];
          newUser = EquipUser(userBasic, equip);
          var newDamage = GetDamage(newUser);
          var effect = (newDamage - userBasic.damage) / userBasic.damage
          $(juexingMap[juexing][1]).text(effect)
          console.log(userBasic);
          console.log(newUser)
        }
      }
      function UpdatePage() {
        $("#user_damage").text(userBasic.minDamage.toString() + ' - ' + userBasic.maxDamage.toString());
        $("#user_equip_attack").text(userBasic.minEquipAttack.toString() + ' - ' + userBasic.maxEquipAttack.toString());
        $("#user_critical_rate").text(userBasic.criticalRate);
        $("#user_critical_damage_rate").text(userBasic.criticalDamage);
        $("#user_expect_damage").text(GetDamage(userBasic));
      }
      $(".user_input").val(0);
      $(".user_input").keyup(function() {
          userBasic = GetUser();
          UpdateJuexing();
          UpdatePage();
      });
    })
  </script>
</head>
<body>
  <div id="main_content">
    <div id="user_status_input">
      <h2>用户状态输入</h2>
      <span class="user_status_option">等级：</span><input class="user_input" id="user_level"/><br>
      <span class="user_status_option">面板最小伤害：</span><input class="user_input" id="user_min_damage"><br>
      <span class="user_status_option">面板最大伤害：</span><input class="user_input" id="user_max_damage"/><br>
      <span class="user_status_option">力量（智力）：</span><input class="user_input" id="user_power_potential"/> + <input class="user_input" id="user_power_other"/><br>
      <span class="user_status_option">附加伤害：</span><input class="user_input" id="user_extra_damage"/><br>
      <span class="user_status_option">神格激活攻击率(%):</span><input class="user_input" id="user_shenge_attack"/><br>
      <span class="user_status_option">技能攻击率(%):</span><input class="user_input" id="user_skill_attack"/><br>
      <span class="user_status_option">暴击值:</span><input class="user_input" id="user_critical_value"/><br>
      <span class="user_status_option">额外暴击率:</span><input class="user_input" id="user_extra_critical_rate"/><br>
      <span class="user_status_option">暴击加成值:</span><input class="user_input" id="user_critical_damage_value"/><br>
      <span class="user_status_option">额外暴击加成率:</span><input class="user_input" id="user_extra_critical_damage_rate"/><br>
      <span class="user_status_option">技能伤害归一化最小值:</span><input class="user_input" id="user_min_skill_damage"/><br>
      <span class="user_status_option">技能伤害归一化最大值:</span><input class="user_input" id="user_max_skill_damage"/><br>
    </div>
    <div id="user_status_general">
      <h2>用户结果</h2>
      <span class="user_status_general">面板伤害：</span><span id="user_damage">0-0</span><br>
      <span class="user_status_general">装备攻击：</span><span id="user_equip_attack">0-0</span><br>
      <span class="user_status_general">暴击率：</span><span id="user_critical_rate">0</span><br>
      <span class="user_status_general">暴击加成率：</span><span id="user_critical_damage_rate">0</span><br>
      <span class="user_status_general">期望伤害：</span><span id="user_expect_damage">0</span><br>
    </div>
    <div id="juexing_effect">
      <h2>觉醒收益</h2>
      <span class="juexing_effect">力量(6)</span><span id="juexing_power">0</span><br>
      <span class="juexing_effect">伤害(27)</span><span id="juexing_equip_damage">0</span><br>
      <span class="juexing_effect">大攻(30)</span><span id="juexing_max_attack">0</span><br>
      <span class="juexing_effect">暴击值(54)</span><span id="juexing_critical_value">0</span><br>
      <span class="juexing_effect">额外暴击率(2.5)</span><span id="juexing_extra_critical_rate">0</span><br>
      <span class="juexing_effect">暴击加成值(54)</span><span id="juexing_critical_damage_value">0</span><br>
      <span class="juexing_effect">额外暴击加成率(7.6)</span><span id="juexing_extra_critical_damage_rate">0</span><br>
    </div>
  </div>
</body>
</html>
